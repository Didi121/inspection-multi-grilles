<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>ABMed â€” Inspections</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• VARIABLES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  /* Monochrome - Style Kenya Hara */
  --white: #FFFFFF;
  --black: #000000;
  --gray-50: #FAFAFA;
  --gray-100: #F5F5F5;
  --gray-200: #E5E5E5;
  --gray-300: #D4D4D4;
  --gray-700: #404040;
  --gray-900: #171717;

  /* Accent unique */
  --accent: #DC2626;
  --accent-light: #FEE2E2;

  /* SÃ©mantique */
  --bg: var(--white);
  --surface: var(--gray-50);
  --border: var(--gray-200);
  --text: var(--gray-900);
  --text-muted: var(--gray-700);

  /* Espacements (Ma é–“) */
  --space-xs: 8px;
  --space-s: 16px;
  --space-m: 32px;
  --space-l: 64px;
  --space-xl: 96px;

  /* Typographie */
  --font: 'DM Sans', -apple-system, sans-serif;
  --mono: 'JetBrains Mono', monospace;

  /* Pas de border-radius */
  --radius: 0;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RESET â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: var(--font);
  background: var(--bg);
  color: var(--text);
  font-size: 16px;
  line-height: 1.75;
  font-weight: 400;
  min-height: 100vh;
  overflow-x: hidden;
}

h1 {
  font-size: 32px;
  font-weight: 400;
  line-height: 1.25;
}

h2 {
  font-size: 24px;
  font-weight: 400;
  line-height: 1.25;
}

h3 {
  font-size: 20px;
  font-weight: 400;
  line-height: 1.25;
}

h4 {
  font-size: 16px;
  font-weight: 500;
}

small {
  font-size: 14px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LAYOUT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.app {
  display: flex;
  flex-direction: column;
  height: 100vh;
}

.main {
  flex: 1;
  display: flex;
  overflow: hidden;
}

.screen {
  display: none;
  flex: 1;
  overflow-y: auto;
}

.screen.visible {
  display: flex;
  flex-direction: column;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOPBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.topbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--space-m) var(--space-l);
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  gap: 12px;
  flex-shrink: 0;
}

.topbar-brand {
  display: flex;
  align-items: center;
  gap: var(--space-s);
  cursor: pointer;
}

.topbar-logo {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 500;
  font-size: 14px;
  color: var(--white);
  background: var(--black);
}

.topbar-title {
  font-weight: 500;
  font-size: 16px;
}

.topbar-sub {
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 2px;
}

.topbar-nav {
  display: flex;
  gap: 8px;
  background: var(--surface);
  padding: 0;
}

.nav-btn {
  padding: var(--space-s) var(--space-m);
  border: none;
  background: transparent;
  color: var(--text-muted);
  font-family: var(--font);
  font-size: 14px;
  cursor: pointer;
}

.nav-btn:hover {
  color: var(--text);
}

.nav-btn.active {
  color: var(--accent);
  border-bottom: 2px solid var(--accent);
}

.topbar-right {
  display: flex;
  align-items: center;
  gap: var(--space-m);
}

.user-pill {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px var(--space-s);
  background: var(--gray-100);
  border: 1px solid var(--border);
  font-size: 14px;
}

.user-pill .role {
  font-size: 12px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.02em;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BUTTONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn-primary {
  width: 100%;
  padding: 12px;
  border: 1px solid var(--accent);
  background: var(--accent);
  color: var(--white);
  font-family: var(--font);
  font-size: 16px;
  font-weight: 500;
  cursor: pointer;
}

.btn-primary:hover {
  background: var(--white);
  color: var(--accent);
}

.btn-sm {
  padding: 8px var(--space-s);
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text);
  font-family: var(--font);
  font-size: 14px;
  cursor: pointer;
}

.btn-sm:hover {
  background: var(--gray-100);
  color: var(--text);
}

.btn-icon {
  width: 32px;
  height: 32px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text-muted);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
}

.btn-icon:hover {
  background: var(--gray-100);
  color: var(--text);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PROGRESS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.progress-strip {
  display: flex;
  align-items: center;
  gap: var(--space-m);
  padding: var(--space-s) var(--space-l);
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.progress-label {
  font-size: 12px;
  color: var(--text-muted);
  font-weight: 500;
  white-space: nowrap;
}

.progress-track {
  flex: 1;
  height: 4px;
  background: var(--border);
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: var(--accent);
}

.progress-count {
  font-family: var(--mono);
  font-size: 14px;
  font-weight: 500;
  white-space: nowrap;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.login-wrap {
  display: flex;
  align-items: center;
  justify-content: center;
  flex: 1;
  padding: var(--space-l);
}

.login-card {
  width: 380px;
  background: var(--surface);
  border: 1px solid var(--border);
  padding: var(--space-l);
}

.login-card h2 {
  text-align: center;
  margin-bottom: 8px;
}

.login-card .sub {
  font-size: 14px;
  color: var(--text-muted);
  text-align: center;
  margin-bottom: var(--space-l);
}

.login-card .err {
  font-size: 14px;
  color: var(--accent);
  text-align: center;
  margin-bottom: var(--space-s);
  min-height: 18px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• FORMS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.field {
  margin-bottom: var(--space-m);
}

.field label {
  display: block;
  font-size: 12px;
  font-weight: 500;
  color: var(--text-muted);
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.02em;
}

.field input,
.field select,
.field textarea {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text);
  font-family: var(--font);
  font-size: 14px;
}

.field input:focus,
.field select:focus,
.field textarea:focus {
  outline: none;
  border-color: var(--accent);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.dash {
  max-width: 960px;
  margin: 0 auto;
  padding: var(--space-l) var(--space-xl);
  width: 100%;
}

.dash-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--space-l);
}

.dash-tabs {
  display: flex;
  gap: 8px;
  margin-bottom: var(--space-l);
}

.dash-tab {
  padding: 8px var(--space-s);
  border: none;
  background: transparent;
  color: var(--text-muted);
  font-family: var(--font);
  font-size: 14px;
  cursor: pointer;
}

.dash-tab:hover {
  color: var(--text);
}

.dash-tab.active {
  color: var(--accent);
  border-bottom: 2px solid var(--accent);
}

.insp-list {
  display: flex;
  flex-direction: column;
  gap: var(--space-m);
}

.insp-card {
  background: var(--surface);
  border: 1px solid var(--border);
  padding: var(--space-m);
  cursor: pointer;
  display: grid;
  grid-template-columns: auto 1fr auto auto;
  align-items: center;
  gap: var(--space-m);
}

.insp-card:hover {
  border-color: var(--text);
}

.insp-icon {
  font-size: 24px;
}

.insp-info h3 {
  font-size: 16px;
  font-weight: 500;
  margin-bottom: 4px;
}

.insp-info p {
  font-size: 14px;
  color: var(--text-muted);
  margin: 0;
}

.insp-progress {
  text-align: right;
}

.insp-progress .pct {
  font-family: var(--mono);
  font-size: 20px;
  font-weight: 500;
}

.insp-progress .lbl {
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 4px;
}

.status-badge {
  font-size: 11px;
  font-weight: 500;
  padding: 6px 12px;
  border: 1px solid var(--border);
  background: var(--gray-100);
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.02em;
  white-space: nowrap;
}

.status-draft {
  background: var(--gray-100);
}

.status-in_progress {
  background: var(--gray-100);
}

.status-completed {
  background: var(--gray-100);
}

.status-validated {
  background: var(--accent-light);
  color: var(--accent);
  border-color: var(--accent);
}

.status-archived {
  background: var(--gray-100);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ADMIN DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.kpi-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: var(--space-m);
  margin-bottom: var(--space-l);
}

.kpi-card {
  background: var(--surface);
  border: 1px solid var(--border);
  padding: var(--space-m);
  text-align: center;
}

.kpi-label {
  font-size: 12px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.02em;
  margin-bottom: 8px;
}

.kpi-value {
  font-size: 28px;
  font-weight: 500;
  font-family: var(--mono);
  color: var(--text);
}

.admin-filters {
  display: flex;
  gap: var(--space-s);
  margin-bottom: var(--space-l);
  flex-wrap: wrap;
}

.admin-filters select {
  padding: 8px 12px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text);
  font-family: var(--font);
  font-size: 14px;
  border-radius: 0;
  min-width: 160px;
}

.admin-filters select:focus {
  outline: none;
  border-color: var(--accent);
}

.export-actions {
  display: flex;
  gap: var(--space-s);
  margin-bottom: var(--space-l);
}

.action-btn {
  padding: 8px 16px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text);
  font-family: var(--font);
  font-size: 14px;
  cursor: pointer;
}

.action-btn:hover {
  background: var(--gray-100);
  border-color: var(--accent);
}

.tbl-admin {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

.tbl-admin th {
  text-align: left;
  padding: 12px;
  font-size: 12px;
  font-weight: 500;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.02em;
  border-bottom: 1px solid var(--border);
  background: var(--surface);
}

.tbl-admin td {
  padding: 12px;
  border-bottom: 1px solid var(--border);
}

.tbl-admin tr:hover td {
  background: var(--gray-50);
}

.tbl-admin .stat-small {
  font-family: var(--mono);
  font-size: 12px;
  color: var(--text-muted);
}

.tbl-admin .action-btn {
  padding: 4px 8px;
  margin-right: 4px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text);
  font-family: var(--font);
  font-size: 12px;
  cursor: pointer;
}

.tbl-admin .action-btn:hover {
  background: var(--gray-100);
}

.empty-state {
  text-align: center;
  padding: var(--space-xl) var(--space-l);
  color: var(--text-muted);
}

.empty-state .icon {
  font-size: 48px;
  margin-bottom: var(--space-m);
  display: block;
}

.empty-state p {
  font-size: 16px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• GRID SELECTOR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.gs {
  max-width: 960px;
  margin: 0 auto;
  padding: var(--space-l) var(--space-xl);
  width: 100%;
}

.gs h1 {
  text-align: center;
}

.gs .sub {
  font-size: 14px;
  color: var(--text-muted);
  text-align: center;
  margin: 8px 0 var(--space-l);
}

.grid-cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: var(--space-m);
}

.grid-card {
  background: var(--surface);
  border: 1px solid var(--border);
  padding: var(--space-l);
  cursor: pointer;
  position: relative;
}

.grid-card:hover {
  border-color: var(--text);
}

.grid-card .icon {
  font-size: 32px;
  margin-bottom: var(--space-s);
  display: block;
}

.grid-card .name {
  font-size: 18px;
  font-weight: 500;
  margin-bottom: 4px;
}

.grid-card .code {
  font-family: var(--mono);
  font-size: 12px;
  color: var(--text-muted);
  margin-bottom: var(--space-s);
}

.grid-card .desc {
  font-size: 14px;
  color: var(--text-muted);
  line-height: 1.6;
  margin-bottom: var(--space-m);
}

.grid-card .stats {
  display: flex;
  gap: var(--space-m);
}

.grid-card .stat {
  font-family: var(--mono);
  font-size: 12px;
  color: var(--text-muted);
  display: flex;
  align-items: center;
  gap: 4px;
}

.grid-card .stat strong {
  color: var(--text);
  font-size: 16px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• META FORM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.meta-form {
  max-width: 560px;
  margin: var(--space-l) auto;
  padding: 0 var(--space-l);
  width: 100%;
}

.meta-back {
  font-size: 14px;
  color: var(--text-muted);
  cursor: pointer;
  margin-bottom: var(--space-m);
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.meta-back:hover {
  color: var(--text);
}

.meta-badge {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  background: var(--gray-100);
  border: 1px solid var(--border);
  font-size: 12px;
  margin-bottom: var(--space-s);
}

.meta-title {
  margin-bottom: 8px;
}

.meta-sub {
  font-size: 14px;
  color: var(--text-muted);
  margin-bottom: var(--space-l);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sidebar {
  width: 240px;
  background: var(--surface);
  border-right: 1px solid var(--border);
  overflow-y: auto;
  flex-shrink: 0;
  padding: 0;
}

.sidebar::-webkit-scrollbar {
  width: 6px;
}

.sidebar::-webkit-scrollbar-thumb {
  background: var(--border);
}

.section-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 14px;
  cursor: pointer;
  border-left: 3px solid transparent;
}

.section-item:hover {
  background: var(--gray-100);
}

.section-item.active {
  border-left-color: var(--accent);
  background: var(--accent-light);
}

.si-num {
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: 500;
  color: var(--text-muted);
  flex-shrink: 0;
  background: var(--gray-100);
}

.section-item.active .si-num {
  background: var(--accent);
  color: var(--white);
}

.si-info {
  flex: 1;
  min-width: 0;
}

.si-name {
  font-size: 14px;
  font-weight: 400;
  line-height: 1.3;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.si-prog {
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 2px;
}

.si-badge {
  font-family: var(--mono);
  font-size: 11px;
  padding: 2px 6px;
  background: var(--gray-100);
  color: var(--text-muted);
}

.si-badge.done {
  color: var(--accent);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CAROUSEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.carousel {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: var(--space-l);
  overflow-y: auto;
}

.c-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 8px;
}

.c-badge {
  font-family: var(--mono);
  font-size: 12px;
  font-weight: 500;
  padding: 4px 8px;
  background: var(--gray-100);
  color: var(--text-muted);
}

.c-section {
  font-size: 12px;
  color: var(--text-muted);
  font-weight: 500;
}

.criterion-card {
  background: var(--surface);
  border: 1px solid var(--border);
  padding: var(--space-l);
  margin-top: 8px;
}

.c-ref {
  font-family: var(--mono);
  font-size: 12px;
  color: var(--text-muted);
  margin-bottom: var(--space-s);
  padding: 6px 8px;
  background: var(--gray-100);
  display: inline-block;
}

.c-text {
  font-size: 16px;
  line-height: 1.75;
  margin-bottom: var(--space-l);
}

.resp-row {
  display: flex;
  gap: var(--space-s);
  margin-bottom: var(--space-m);
}

.resp-btn {
  flex: 1;
  padding: 12px;
  border: 2px solid var(--border);
  background: var(--surface);
  color: var(--text);
  font-family: var(--font);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.resp-btn:hover {
  border-color: var(--text);
}

.resp-btn.oui.sel {
  border-color: var(--accent);
  background: var(--accent-light);
  color: var(--accent);
}

.resp-btn.non.sel {
  border-color: var(--accent);
  background: var(--accent-light);
  color: var(--accent);
}

.obs-lbl {
  font-size: 12px;
  font-weight: 500;
  color: var(--text-muted);
  margin-bottom: 6px;
}

.obs-input {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text);
  font-family: var(--font);
  font-size: 14px;
  resize: vertical;
  min-height: 60px;
}

.obs-input:focus {
  outline: none;
  border-color: var(--accent);
}

.obs-input::placeholder {
  color: var(--text-muted);
}

.c-nav {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: var(--space-l);
  padding-top: var(--space-s);
  border-top: 1px solid var(--border);
}

.nav-arr {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px var(--space-s);
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text);
  font-family: var(--font);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
}

.nav-arr:hover {
  background: var(--gray-100);
}

.nav-arr:disabled {
  opacity: 0.3;
  cursor: default;
}

.nav-arr.primary {
  background: var(--accent);
  color: var(--white);
  border-color: var(--accent);
}

.nav-arr.primary:hover {
  background: var(--text);
  color: var(--white);
}

.nav-cnt {
  font-family: var(--mono);
  font-size: 14px;
  color: var(--text-muted);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• REPORT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.report {
  max-width: 780px;
  margin: 0 auto;
  padding: var(--space-l) var(--space-xl);
  width: 100%;
  overflow-y: auto;
  flex: 1;
}

.report h2 {
  text-align: center;
}

.report .sub {
  font-size: 14px;
  color: var(--text-muted);
  text-align: center;
  margin: 8px 0 var(--space-l);
}

.stats-g {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: var(--space-s);
  margin-bottom: var(--space-l);
}

.stat-c {
  background: var(--surface);
  border: 1px solid var(--border);
  padding: var(--space-m);
  text-align: center;
}

.stat-v {
  font-family: var(--mono);
  font-size: 24px;
  font-weight: 500;
  color: var(--text);
}

.stat-l {
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 8px;
  font-weight: 500;
}

.conf-bar {
  height: 6px;
  background: var(--border);
  overflow: hidden;
  margin-bottom: var(--space-l);
}

.conf-fill {
  height: 100%;
  background: var(--accent);
}

.ec-title {
  font-size: 16px;
  font-weight: 500;
  margin-bottom: var(--space-m);
  display: flex;
  align-items: center;
  gap: 12px;
}

.ec-count {
  font-family: var(--mono);
  font-size: 12px;
  padding: 4px 8px;
  background: var(--accent-light);
  color: var(--accent);
}

.ecart-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-left: 3px solid var(--accent);
  padding: var(--space-m);
  margin-bottom: var(--space-s);
}

.ecart-card .sec {
  font-size: 11px;
  color: var(--text-muted);
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.02em;
}

.ecart-card .desc {
  font-size: 14px;
  margin-top: 6px;
  line-height: 1.6;
}

.ecart-card .ref {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--text-muted);
  margin-top: 6px;
}

.ecart-card .obs {
  margin-top: 8px;
  padding: 8px 10px;
  background: var(--gray-100);
  font-size: 14px;
  color: var(--text-muted);
  font-style: italic;
  line-height: 1.6;
}

.rpt-actions {
  display: flex;
  gap: var(--space-s);
  justify-content: center;
  padding: var(--space-s) 0 var(--space-l);
  border-top: 1px solid var(--border);
  margin-top: var(--space-m);
  flex-wrap: wrap;
}

.btn-rpt {
  padding: 8px var(--space-s);
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text);
  font-family: var(--font);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
}

.btn-rpt:hover {
  background: var(--gray-100);
}

.btn-rpt.primary {
  background: var(--accent);
  color: var(--white);
  border-color: var(--accent);
}

.btn-rpt.primary:hover {
  background: var(--text);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ADMIN PANELS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.panel {
  max-width: 960px;
  margin: 0 auto;
  padding: var(--space-l) var(--space-xl);
  width: 100%;
}

.panel h2 {
  margin-bottom: var(--space-l);
  display: flex;
  align-items: center;
  gap: 12px;
}

.tbl {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

.tbl th {
  text-align: left;
  padding: 12px;
  font-size: 12px;
  font-weight: 500;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.02em;
  border-bottom: 1px solid var(--border);
  background: var(--surface);
}

.tbl td {
  padding: 12px;
  border-bottom: 1px solid var(--border);
}

.tbl tr:hover td {
  background: var(--gray-50);
}

.tbl .mono {
  font-family: var(--mono);
  font-size: 12px;
  color: var(--text-muted);
}

.role-tag {
  font-size: 11px;
  padding: 4px 8px;
  font-weight: 500;
  text-transform: uppercase;
  background: var(--gray-100);
  color: var(--text-muted);
  border: 1px solid var(--border);
}

.role-admin {
  background: var(--accent-light);
  color: var(--accent);
  border-color: var(--accent);
}

.role-lead_inspector {
  background: var(--gray-100);
  color: var(--text-muted);
}

.role-inspector {
  background: var(--gray-100);
  color: var(--text-muted);
}

.role-viewer {
  background: var(--gray-100);
  color: var(--text-muted);
}

.active-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  display: inline-block;
}

.active-dot.on {
  background: var(--accent);
}

.active-dot.off {
  background: var(--text-muted);
}

.action-tag {
  font-size: 11px;
  padding: 4px 8px;
  font-weight: 500;
  font-family: var(--mono);
  background: var(--gray-100);
  color: var(--text-muted);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100;
  display: none;
}

.modal-overlay.visible {
  display: flex;
}

.modal {
  background: var(--surface);
  border: 1px solid var(--border);
  padding: var(--space-l);
  width: 420px;
  max-width: 90vw;
  max-height: 80vh;
  overflow-y: auto;
}

.modal h3 {
  font-size: 18px;
  font-weight: 500;
  margin-bottom: var(--space-m);
}

.modal-actions {
  display: flex;
  gap: var(--space-s);
  justify-content: flex-end;
  margin-top: var(--space-m);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RESPONSIVE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 768px) {
  .sidebar {
    display: none;
  }

  .carousel {
    padding: var(--space-m);
  }

  .stats-g {
    grid-template-columns: repeat(2, 1fr);
  }

  .grid-cards {
    grid-template-columns: 1fr;
  }

  .insp-card {
    grid-template-columns: auto 1fr auto;
  }

  .dash {
    padding: var(--space-m);
  }

  .report {
    padding: var(--space-m);
  }

  .topbar {
    padding: var(--space-s) var(--space-m);
  }
}
</style>
</head>
<body>
<div class="app">
  <!-- TOPBAR -->
  <div class="topbar">
    <div class="topbar-brand" onclick="goToDashboard()">
      <div class="topbar-logo" id="tLogo">ABM</div>
      <div>
        <div class="topbar-title" id="tTitle">ABMed Inspections</div>
        <div class="topbar-sub" id="tSub">Connexion</div>
      </div>
    </div>
    <div class="topbar-nav" id="tNav" style="display:none"></div>
    <div class="topbar-right" id="tRight" style="display:none">
      <div class="user-pill"><span id="tUser">â€”</span><span class="role" id="tRole">â€”</span></div>
      <button class="btn-sm" onclick="doLogout()">DÃ©connexion</button>
    </div>
  </div>
  <div class="progress-strip" id="pStrip" style="display:none">
    <span class="progress-label">Progression</span>
    <div class="progress-track"><div class="progress-fill" id="pFill" style="width:0%"></div></div>
    <span class="progress-count" id="pCount">0/0</span>
  </div>

  <!-- LOGIN -->
  <div class="screen visible" id="s-login">
    <div class="login-wrap">
      <div class="login-card">
        <h2>Connexion</h2>
        <p class="sub">Inspections pharmaceutiques ABMed</p>
        <div class="err" id="loginErr"></div>
        <div class="field"><label>Nom d'utilisateur</label><input id="loginUser" placeholder="admin"/></div>
        <div class="field"><label>Mot de passe</label><input id="loginPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="if(event.key==='Enter')doLogin()"/></div>
        <button class="btn-primary" onclick="doLogin()">Se connecter</button>
      </div>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div class="screen" id="s-dash">
    <div class="dash">
      <div class="dash-header">
        <h1>Mes inspections</h1>
        <button class="btn-primary" style="width:auto;padding:8px 16px;font-size:14px" onclick="showScreen('grid-select')">+ Nouvelle inspection</button>
      </div>
      <div class="dash-tabs" id="dashTabs"></div>
      <div class="insp-list" id="inspList"></div>
    </div>
  </div>

  <!-- ADMIN DASHBOARD -->
  <div class="screen" id="s-admin-dash">
    <div class="dash">
      <div class="dash-header">
        <h1>Tableau de bord administrateur</h1>
        <button class="btn-primary" style="width:auto;padding:8px 16px;font-size:14px" onclick="showScreen('grid-select')">+ Nouvelle inspection</button>
      </div>

      <!-- KPIs -->
      <div class="kpi-grid">
        <div class="kpi-card">
          <div class="kpi-label">Total inspections</div>
          <div class="kpi-value" id="kpi-total">0</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">En cours</div>
          <div class="kpi-value" id="kpi-progress" style="color:var(--accent)">0</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">ComplÃ©tÃ©es</div>
          <div class="kpi-value" id="kpi-complete" style="color:var(--accent)">0</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">ValidÃ©es</div>
          <div class="kpi-value" id="kpi-validated" style="color:var(--accent)">0</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Ã‰carts dÃ©tectÃ©s</div>
          <div class="kpi-value" id="kpi-gaps" style="color:var(--accent)">0</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Taux conformitÃ©</div>
          <div class="kpi-value" id="kpi-conformity">â€”</div>
        </div>
      </div>

      <!-- Filtres -->
      <div class="admin-filters">
        <select id="filterStatus" onchange="loadAdminDashboard()">
          <option value="">Tous les statuts</option>
          <option value="draft">Brouillon</option>
          <option value="in_progress">En cours</option>
          <option value="completed">TerminÃ©e</option>
          <option value="validated">ValidÃ©e</option>
        </select>
        <select id="filterGrid" onchange="loadAdminDashboard()">
          <option value="">Toutes les grilles</option>
          <option value="officine">Officine</option>
          <option value="grossiste">Grossiste</option>
        </select>
        <select id="filterInspector" onchange="loadAdminDashboard()">
          <option value="">Tous les inspecteurs</option>
          <option value="">â€” En cours de chargement â€”</option>
        </select>
      </div>

      <!-- Export Actions -->
      <div class="export-actions">
        <button class="action-btn" onclick="exportAdminDataCSV()">ğŸ“Š Export CSV</button>
        <button class="action-btn" onclick="exportAdminDataJSON()">ğŸ“„ Export JSON</button>
        <button class="action-btn" onclick="window.print()">ğŸ–¨ï¸ Imprimer</button>
      </div>

      <!-- Tableau -->
      <div style="overflow-x:auto">
        <table class="tbl-admin">
          <thead>
            <tr>
              <th>Ã‰tablissement</th>
              <th>Grille</th>
              <th>Inspecteur</th>
              <th>Date</th>
              <th>Statut</th>
              <th>ProgrÃ¨s</th>
              <th>Ã‰carts</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="adminTableBody">
            <tr><td colspan="8" style="text-align:center">Chargement...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- GRID SELECTOR -->
  <div class="screen" id="s-grid-select">
    <div class="gs">
      <h1>Choisir une grille</h1>
      <p class="sub">SÃ©lectionnez le type d'Ã©tablissement Ã  inspecter</p>
      <div class="grid-cards" id="gridCards"></div>
    </div>
  </div>

  <!-- META -->
  <div class="screen" id="s-meta">
    <div class="meta-form">
      <div class="meta-back" onclick="showScreen('grid-select')">â† Changer de grille</div>
      <div class="meta-badge" id="metaBadge"></div>
      <h1 class="meta-title">Nouvelle inspection</h1>
      <p class="meta-sub">Informations gÃ©nÃ©rales</p>
      <div class="field"><label>Date</label><input type="date" id="mDate"/></div>
      <div class="field"><label>Ã‰tablissement</label><input id="mEstab" placeholder="Ex: Pharmacie du Carrefour"/></div>
      <div class="field"><label>Type d'inspection</label><select id="mType"><option>Routine</option><option>EnquÃªte</option><option>Plaintes/rÃ©clamations</option><option>Ã€ la demande</option><option>PrÃ©-ouverture</option><option>Visite de conformitÃ©</option><option>Autre</option></select></div>
      <div class="field"><label>Inspecteurs (sÃ©parÃ©s par virgule)</label><input id="mInsp" placeholder="Dr. Konou, Dr. Ahouansou"/></div>
      <button class="btn-primary" id="btnStart" onclick="createAndStart()">DÃ©marrer l'inspection â†’</button>
    </div>
  </div>

  <!-- INSPECTION -->
  <div class="screen" id="s-inspection"><div class="main"><div class="sidebar" id="secList"></div><div class="carousel" id="carArea"></div></div></div>

  <!-- REPORT -->
  <div class="screen" id="s-report"><div class="report" id="rptContent"></div></div>

  <!-- USERS -->
  <div class="screen" id="s-users"><div class="panel" id="usersPanel"></div></div>

  <!-- AUDIT -->
  <div class="screen" id="s-audit"><div class="panel" id="auditPanel"></div></div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()">
  <div class="modal" id="modalContent"></div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CORE STATE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let session = null;
let gridsData = [];
let activeGrid = null;
let sections = [], allCriteria = [], responses = {};
let currentIndex = 0, currentInspectionId = null;
const T = window.__TAURI__;
const isTauri = !!T;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• INVOKE / FALLBACK DB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function invoke(cmd, args={}) {
  if (isTauri) return T.core.invoke(cmd, args);
  return fallback(cmd, args);
}

const DB = { users: [], inspections: [], responses: {}, audit: [], sessions: {} };
function initFallbackDB() {
  if (!DB.users.length) {
    const id = crypto.randomUUID();
    DB.users.push({ id, username:'admin', full_name:'Administrateur', role:'admin', active:true,
      password:'admin123', created_at: now(), updated_at: now() });
    DB.users.push({ id: crypto.randomUUID(), username:'inspecteur1', full_name:'Dr. Konou',
      role:'inspector', active:true, password:'pass123', created_at: now(), updated_at: now() });
  }
}
function now() { return new Date().toISOString().replace('T',' ').substring(0,19); }
function addAudit(userId, username, action, entityType, entityId, details) {
  DB.audit.unshift({ id: DB.audit.length+1, timestamp: now(), user_id: userId, username, action, entity_type: entityType, entity_id: entityId, details });
}

function fallback(cmd, a) {
  initFallbackDB();
  switch(cmd) {
    case 'list_grids': return buildAllGridsJS().map(g=>({...g, criteria_count:g.sections.reduce((s,sec)=>s+sec.items.length,0), section_count:g.sections.length}));
    case 'get_grid': return buildAllGridsJS().find(g=>g.id===a.gridId)||null;
    case 'cmd_login': {
      const u = DB.users.find(x=>x.username===a.username&&x.password===a.password&&x.active);
      if(!u) throw 'Identifiants incorrects';
      const tok = crypto.randomUUID();
      DB.sessions[tok] = u.id;
      addAudit(u.id, u.username, 'LOGIN', 'session', tok, '');
      return { token:tok, user:{id:u.id,username:u.username,full_name:u.full_name,role:u.role,active:u.active,created_at:u.created_at,updated_at:u.updated_at}};
    }
    case 'cmd_logout': delete DB.sessions[a.token]; return null;
    case 'cmd_validate_session': {
      const uid = DB.sessions[a.token]; if(!uid) throw 'Session invalide';
      const u = DB.users.find(x=>x.id===uid); if(!u||!u.active) throw 'Session invalide';
      return {id:u.id,username:u.username,full_name:u.full_name,role:u.role,active:u.active,created_at:u.created_at,updated_at:u.updated_at};
    }
    case 'cmd_list_users': return DB.users.map(u=>({id:u.id,username:u.username,full_name:u.full_name,role:u.role,active:u.active,created_at:u.created_at,updated_at:u.updated_at}));
    case 'cmd_create_user': {
      const nu = {id:crypto.randomUUID(), username:a.req.username, full_name:a.req.full_name, role:a.req.role, password:a.req.password, active:true, created_at:now(), updated_at:now()};
      DB.users.push(nu); addAudit(null,null,'CREATE_USER','user',nu.id,nu.username);
      return {id:nu.id,username:nu.username,full_name:nu.full_name,role:nu.role,active:true,created_at:nu.created_at,updated_at:nu.updated_at};
    }
    case 'cmd_update_user': {
      const u = DB.users.find(x=>x.id===a.userId);
      if(u){ if(a.req.full_name)u.full_name=a.req.full_name; if(a.req.role)u.role=a.req.role; if(a.req.active!==undefined)u.active=a.req.active; u.updated_at=now(); }
      return null;
    }
    case 'cmd_change_password': { const u=DB.users.find(x=>x.id===a.userId); if(u)u.password=a.newPassword; return null; }
    case 'cmd_delete_user': { const u=DB.users.find(x=>x.id===a.userId); if(u){u.active=false;} return null; }
    case 'cmd_create_inspection': {
      const id=crypto.randomUUID();
      DB.inspections.push({id, grid_id:a.req.grid_id, status:'draft', date_inspection:a.req.date_inspection, establishment:a.req.establishment,
        inspection_type:a.req.inspection_type, inspectors:a.req.inspectors, created_by:session?.user?.id, created_by_name:session?.user?.full_name,
        validated_by:null,validated_by_name:null,validated_at:null, created_at:now(), updated_at:now(), progress:{total:0,answered:0,conforme:0,non_conforme:0}});
      DB.responses[id]={};
      addAudit(session?.user?.id, session?.user?.username, 'CREATE_INSPECTION','inspection',id, a.req.establishment);
      return id;
    }
    case 'cmd_list_inspections': return DB.inspections.filter(i=>{
      if(a.myOnly && i.created_by!==session?.user?.id) return false;
      if(a.status && i.status!==a.status) return false; return true;
    }).sort((a,b)=>b.updated_at.localeCompare(a.updated_at));
    case 'cmd_get_inspection': return DB.inspections.find(i=>i.id===a.inspectionId);
    case 'cmd_get_responses': {
      const r = DB.responses[a.inspectionId]||{};
      return Object.entries(r).map(([cid,v])=>({criterion_id:parseInt(cid), conforme:v.conforme, observation:v.observation||'', updated_by:v.updated_by, updated_at:v.updated_at||now()}));
    }
    case 'cmd_save_response': {
      if(!DB.responses[a.inspectionId]) DB.responses[a.inspectionId]={};
      DB.responses[a.inspectionId][a.criterionId]={conforme:a.conforme, observation:a.observation, updated_by:session?.user?.id, updated_at:now()};
      const insp=DB.inspections.find(i=>i.id===a.inspectionId);
      if(insp){insp.status=insp.status==='draft'?'in_progress':insp.status; insp.updated_at=now();
        const r=DB.responses[a.inspectionId]; const vals=Object.values(r);
        insp.progress={total:vals.length, answered:vals.filter(v=>v.conforme!==null).length, conforme:vals.filter(v=>v.conforme===true).length, non_conforme:vals.filter(v=>v.conforme===false).length};
      }
      return null;
    }
    case 'cmd_set_inspection_status': {
      const insp=DB.inspections.find(i=>i.id===a.inspectionId);
      if(insp){insp.status=a.status; insp.updated_at=now(); if(a.status==='validated'){insp.validated_by=session?.user?.id;insp.validated_by_name=session?.user?.full_name;insp.validated_at=now();}}
      addAudit(session?.user?.id, session?.user?.username, 'SET_STATUS_'+a.status.toUpperCase(),'inspection',a.inspectionId,'');
      return null;
    }
    case 'cmd_delete_inspection': { DB.inspections=DB.inspections.filter(i=>i.id!==a.inspectionId); delete DB.responses[a.inspectionId]; return null; }
    case 'cmd_query_audit': {
      let logs = [...DB.audit];
      if(a.filter.user_id) logs=logs.filter(l=>l.user_id===a.filter.user_id);
      if(a.filter.action) logs=logs.filter(l=>l.action===a.filter.action);
      if(a.filter.entity_type) logs=logs.filter(l=>l.entity_type===a.filter.entity_type);
      const limit=a.filter.limit||100, offset=a.filter.offset||0;
      return logs.slice(offset, offset+limit);
    }
    case 'cmd_count_audit': return DB.audit.length;
    default: return null;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• AUTH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doLogin() {
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value;
  try {
    session = await invoke('cmd_login',{username:u,password:p});
    document.getElementById('loginErr').textContent = '';
    afterLogin();
  } catch(e) { document.getElementById('loginErr').textContent = e.toString(); }
}
async function doLogout() {
  if(session) try { await invoke('cmd_logout',{token:session.token}); } catch(_){}
  session = null; currentInspectionId=null;
  document.getElementById('tRight').style.display='none';
  document.getElementById('tNav').style.display='none';
  showScreen('login');
}
async function afterLogin() {
  document.getElementById('tRight').style.display='flex';
  document.getElementById('tUser').textContent=session.user.full_name;
  document.getElementById('tRole').textContent=roleLabel(session.user.role);
  gridsData = await invoke('list_grids');
  buildTopNav();

  const isAdmin = ['admin','lead_inspector'].includes(session.user.role);
  if (isAdmin) {
    showScreen('admin-dash');
    loadAdminDashboard();
  } else {
    showScreen('dash');
    loadDashboard();
  }
}
function roleLabel(r){ return {admin:'Admin',lead_inspector:'Inspecteur en chef',inspector:'Inspecteur',viewer:'Lecteur'}[r]||r; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOP NAV â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildTopNav() {
  const nav = document.getElementById('tNav');
  const isAdmin = ['admin','lead_inspector'].includes(session.user.role);
  nav.innerHTML = `
    ${isAdmin?'<button class="nav-btn" data-s="admin-dash" onclick="showScreen(\'admin-dash\');loadAdminDashboard()">Tableau de bord</button>':'<button class="nav-btn" data-s="dash" onclick="goToDashboard()">Inspections</button>'}
    ${!isAdmin?'':''}
    ${isAdmin?'<button class="nav-btn" data-s="users" onclick="showScreen(\'users\');renderUsers()">Utilisateurs</button>':''}
    ${isAdmin?'<button class="nav-btn" data-s="audit" onclick="showScreen(\'audit\');renderAudit()">Audit</button>':''}
  `;
  nav.style.display='flex';
}
function goToDashboard() {
  if(!session) return;
  currentInspectionId=null;
  document.getElementById('tTitle').textContent='ABMed Inspections';
  document.getElementById('tSub').textContent='Tableau de bord';
  document.getElementById('tLogo').style.background='var(--black)';
  document.getElementById('pStrip').style.display='none';

  const isAdmin = ['admin','lead_inspector'].includes(session.user.role);
  if (isAdmin) {
    showScreen('admin-dash'); loadAdminDashboard();
  } else {
    showScreen('dash'); loadDashboard();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCREENS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(el=>el.classList.remove('visible'));
  document.getElementById('s-'+name).classList.add('visible');
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.toggle('active',b.dataset.s===name));
  document.getElementById('pStrip').style.display=name==='inspection'?'flex':'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let dashFilter = null;
async function loadDashboard() {
  const tabs = document.getElementById('dashTabs');
  tabs.innerHTML = ['Toutes','draft','in_progress','completed','validated'].map(s=>{
    const label = s==='Toutes'?'Toutes':({draft:'Brouillon',in_progress:'En cours',completed:'TerminÃ©es',validated:'ValidÃ©es'}[s]);
    const val = s==='Toutes'?null:s;
    return `<button class="dash-tab ${dashFilter===val?'active':''}" onclick="dashFilter=${val===null?'null':"'"+val+"'"};loadDashboard()">${label}</button>`;
  }).join('');

  try {
    const list = await invoke('cmd_list_inspections',{token:session.token, myOnly:session.user.role==='inspector', status:dashFilter});
    const el = document.getElementById('inspList');
    if(!list.length) {
      el.innerHTML = `<div class="empty-state"><span class="icon">ğŸ“‹</span><p>Aucune inspection${dashFilter?' avec ce filtre':''}.<br>Cliquez sur "Nouvelle inspection" pour commencer.</p></div>`;
      return;
    }
    const gridMap = {}; gridsData.forEach(g=>gridMap[g.id]=g);
    el.innerHTML = list.map(i=>{
      const g = gridMap[i.grid_id]||{icon:'ğŸ“‹',name:i.grid_id,color:'var(--accent)'};
      const pct = i.progress.answered>0?Math.round((i.progress.conforme/i.progress.answered)*100):0;
      return `<div class="insp-card" onclick="openInspection('${i.id}')">
        <div class="insp-icon">${g.icon}</div>
        <div class="insp-info"><h3>${i.establishment||'Sans nom'}</h3><p>${g.name} Â· ${i.date_inspection||'â€”'} Â· ${i.created_by_name||'â€”'}</p></div>
        <div class="insp-progress"><div class="pct">${i.progress.answered}</div><div class="lbl">rÃ©ponses</div></div>
        <span class="status-badge status-${i.status}">${statusLabel(i.status)}</span>
      </div>`;
    }).join('');
  } catch(e){ console.error(e); }
}
function statusLabel(s){ return {draft:'Brouillon',in_progress:'En cours',completed:'TerminÃ©e',validated:'ValidÃ©e',archived:'ArchivÃ©e'}[s]||s; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ADMIN DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAdminDashboard() {
  try {
    const list = await invoke('cmd_list_inspections',{token:session.token, myOnly:false, status:null});
    const gridMap = {}; gridsData.forEach(g=>gridMap[g.id]=g);

    const status = document.getElementById('filterStatus')?.value || '';
    const gridFilter = document.getElementById('filterGrid')?.value || '';
    const inspectorFilter = document.getElementById('filterInspector')?.value || '';

    let filtered = list;
    if (status) filtered = filtered.filter(i => i.status === status);
    if (gridFilter) filtered = filtered.filter(i => i.grid_id === gridFilter);
    if (inspectorFilter) filtered = filtered.filter(i => i.created_by_name === inspectorFilter);

    const total = list.length;
    const inProgress = list.filter(i => i.status === 'in_progress').length;
    const completed = list.filter(i => i.status === 'completed').length;
    const validated = list.filter(i => i.status === 'validated').length;

    let totalGaps = 0, totalConforme = 0, totalAnswered = 0;
    list.forEach(i => {
      totalGaps += i.progress?.non_conforme || 0;
      totalConforme += i.progress?.conforme || 0;
      totalAnswered += i.progress?.answered || 0;
    });
    const conformity = totalAnswered > 0 ? Math.round((totalConforme / totalAnswered) * 100) : 'â€”';

    document.getElementById('kpi-total').textContent = total;
    document.getElementById('kpi-progress').textContent = inProgress;
    document.getElementById('kpi-complete').textContent = completed;
    document.getElementById('kpi-validated').textContent = validated;
    document.getElementById('kpi-gaps').textContent = totalGaps;
    document.getElementById('kpi-conformity').textContent = conformity === 'â€”' ? 'â€”' : conformity + '%';

    const tbody = document.getElementById('adminTableBody');
    tbody.innerHTML = filtered.map(i => {
      const g = gridMap[i.grid_id] || {icon:'ğŸ“‹', name:i.grid_id};
      const pct = i.progress.answered > 0 ? Math.round((i.progress.conforme/i.progress.answered)*100) : 0;
      return `<tr>
        <td><strong>${i.establishment || 'Sans nom'}</strong></td>
        <td>${g.name}</td>
        <td>${i.created_by_name || 'â€”'}</td>
        <td class="stat-small">${i.date_inspection || 'â€”'}</td>
        <td><span class="status-badge status-${i.status}">${statusLabel(i.status)}</span></td>
        <td class="stat-small">${i.progress.answered}/${i.progress.total} (${pct}%)</td>
        <td class="stat-small" style="color:var(--accent)">${i.progress.non_conforme}</td>
        <td><button class="action-btn" onclick="openInspection('${i.id}')">Voir</button></td>
      </tr>`;
    }).join('');

    if (filtered.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" style="text-align:center">Aucune inspection</td></tr>';
    }
  } catch(e) { console.error(e); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ADMIN EXPORT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function exportAdminDataCSV() {
  try {
    const list = await invoke('cmd_list_inspections',{token:session.token, myOnly:false, status:null});
    const gridMap = {}; gridsData.forEach(g=>gridMap[g.id]=g);
    let csv = 'Ã‰tablissement,Grille,Inspecteur,Date,Statut,Total,RÃ©ponses,Conforme,Non-conforme,% ConformitÃ©\n';
    list.forEach(i => {
      const g = gridMap[i.grid_id] || {name:i.grid_id};
      const pct = i.progress.answered > 0 ? Math.round((i.progress.conforme/i.progress.answered)*100) : 0;
      csv += `"${i.establishment || '-'}","${g.name}","${i.created_by_name || '-'}","${i.date_inspection || '-'}","${statusLabel(i.status)}",${i.progress.total},${i.progress.answered},${i.progress.conforme},${i.progress.non_conforme},${pct}%\n`;
    });
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `inspections_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
  } catch(e) { alert('Erreur export: '+e); }
}

async function exportAdminDataJSON() {
  try {
    const list = await invoke('cmd_list_inspections',{token:session.token, myOnly:false, status:null});
    const gridMap = {}; gridsData.forEach(g=>gridMap[g.id]=g);
    const data = {
      export_date: new Date().toISOString(),
      total_count: list.length,
      inspections: list.map(i => {
        const g = gridMap[i.grid_id] || {name:i.grid_id};
        return {id:i.id, establishment:i.establishment, grid:g.name, inspector:i.created_by_name, date:i.date_inspection,
          status:i.status, progress:i.progress, conformity_percent:i.progress.answered > 0 ? Math.round((i.progress.conforme/i.progress.answered)*100) : 0};
      })
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `inspections_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
  } catch(e) { alert('Erreur export: '+e); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• OPEN / RESUME INSPECTION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function openInspection(id) {
  try {
    const insp = await invoke('cmd_get_inspection',{token:session.token, inspectionId:id});
    const savedResps = await invoke('cmd_get_responses',{token:session.token, inspectionId:id});
    const grid = await invoke('get_grid',{gridId:insp.grid_id});
    if(!grid) { alert('Grille introuvable: '+insp.grid_id); return; }

    currentInspectionId = id;
    activeGrid = grid; sections = grid.sections;
    allCriteria = []; sections.forEach(s=>s.items.forEach(item=>allCriteria.push({...item, sectionTitle:s.title, sectionId:s.id})));
    responses = {};
    savedResps.forEach(r=>{ responses[r.criterion_id] = { conforme:r.conforme, observation:r.observation }; });
    currentIndex = 0;

    document.getElementById('tTitle').textContent=grid.name;
    document.getElementById('tSub').textContent=insp.establishment||grid.code;
    document.getElementById('tLogo').style.background='var(--accent)';
    showScreen('inspection');
    renderSidebar(); renderCriterion(); updateProgress();
  } catch(e){ alert('Erreur: '+e); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• GRID SELECTOR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderGridSelector() {
  if(!gridsData.length) gridsData = await invoke('list_grids');
  document.getElementById('gridCards').innerHTML = gridsData.map(g=>`
    <div class="grid-card" onclick="selectGrid('${g.id}')">
      <span class="icon">${g.icon}</span>
      <div class="name">${g.name}</div>
      <div class="code">${g.code}</div>
      <div class="desc">${g.description}</div>
      <div class="stats"><div class="stat"><strong>${g.criteria_count}</strong> critÃ¨res</div><div class="stat"><strong>${g.section_count}</strong> sections</div></div>
    </div>
  `).join('');
  showScreen('grid-select');
}

async function selectGrid(gridId) {
  const grid = await invoke('get_grid',{gridId});
  activeGrid = grid; sections = grid.sections;
  allCriteria = []; sections.forEach(s=>s.items.forEach(item=>allCriteria.push({...item, sectionTitle:s.title, sectionId:s.id})));
  responses = {}; currentIndex = 0;
  document.getElementById('metaBadge').innerHTML=`<span>${grid.icon}</span> ${grid.name}`;
  document.getElementById('btnStart').style.background='var(--accent)';
  document.getElementById('mDate').value=new Date().toISOString().split('T')[0];
  showScreen('meta');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CREATE INSPECTION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function createAndStart() {
  const req = {
    grid_id: activeGrid.id,
    date_inspection: document.getElementById('mDate').value,
    establishment: document.getElementById('mEstab').value,
    inspection_type: document.getElementById('mType').value,
    inspectors: document.getElementById('mInsp').value.split(',').map(s=>s.trim()).filter(Boolean)
  };
  try {
    currentInspectionId = await invoke('cmd_create_inspection',{token:session.token, req});
    document.getElementById('tTitle').textContent=activeGrid.name;
    document.getElementById('tSub').textContent=req.establishment||activeGrid.code;
    document.getElementById('tLogo').style.background='var(--accent)';
    showScreen('inspection');
    renderSidebar(); renderCriterion(); updateProgress();
  } catch(e){ alert('Erreur: '+e); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSidebar() {
  const list=document.getElementById('secList'); list.innerHTML='';
  let idx=0;
  sections.forEach(s=>{
    const start=idx, total=s.items.length;
    const ans=s.items.filter(i=>responses[i.id]&&responses[i.id].conforme!==null&&responses[i.id].conforme!==undefined).length;
    const cur=currentIndex>=start&&currentIndex<start+total;
    const el=document.createElement('div'); el.className='section-item'+(cur?' active':'');
    el.innerHTML=`<div class="si-num">${s.id}</div>
      <div class="si-info"><div class="si-name">${s.title}</div><div class="si-prog">${ans}/${total}</div></div>
      <div class="si-badge ${ans===total?'done':''}">${ans===total?'âœ“':ans+'/'+total}</div>`;
    el.onclick=()=>{currentIndex=start;renderCriterion();renderSidebar()};
    list.appendChild(el); idx+=total;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CAROUSEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCriterion() {
  const area=document.getElementById('carArea');
  if(!allCriteria.length||currentIndex<0||currentIndex>=allCriteria.length)return;
  const c=allCriteria[currentIndex];
  const r=responses[c.id]||{conforme:null,observation:''};
  area.innerHTML=`
    <div class="c-header">
      <span class="c-badge">${c.pre_opening?'â–º PrÃ©-ouverture':'CritÃ¨re '+c.id}</span>
      <span class="c-section">${c.sectionTitle}</span>
    </div>
    <div class="criterion-card">
      ${c.reference?`<div class="c-ref">${c.reference}</div>`:''}
      <div class="c-text">${c.description}</div>
      <div class="resp-row">
        <button class="resp-btn oui ${r.conforme===true?'sel':''}" onclick="setResp(${c.id},true)">âœ“ Conforme</button>
        <button class="resp-btn non ${r.conforme===false?'sel':''}" onclick="setResp(${c.id},false)">âœ• Non conforme</button>
      </div>
      <div class="obs-lbl">Observations</div>
      <textarea class="obs-input" placeholder="Observationâ€¦" oninput="updateObs(${c.id},this.value)">${r.observation||''}</textarea>
    </div>
    <div class="c-nav">
      <button class="nav-arr" onclick="nav(-1)" ${currentIndex===0?'disabled':''}>â† PrÃ©cÃ©dent</button>
      <span class="nav-cnt">${currentIndex+1} / ${allCriteria.length}</span>
      ${currentIndex<allCriteria.length-1
        ?`<button class="nav-arr primary" onclick="nav(1)">Suivant â†’</button>`
        :`<button class="nav-arr primary" onclick="showScreen('report');renderReport()">Rapport â†’</button>`}
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RESPONSES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function setResp(id,val) {
  if(!responses[id]) responses[id]={conforme:null,observation:''};
  responses[id].conforme=val;
  if(currentInspectionId && session) {
    try { await invoke('cmd_save_response',{token:session.token, inspectionId:currentInspectionId, criterionId:id, conforme:val, observation:responses[id].observation||''}); }
    catch(e){ console.error('Save error',e); }
  }
  renderCriterion(); updateProgress(); renderSidebar();
}
async function updateObs(id,text) {
  if(!responses[id]) responses[id]={conforme:null,observation:''};
  responses[id].observation=text;
  clearTimeout(updateObs._t);
  updateObs._t = setTimeout(async()=>{
    if(currentInspectionId && session) {
      try { await invoke('cmd_save_response',{token:session.token, inspectionId:currentInspectionId, criterionId:id, conforme:responses[id].conforme, observation:text}); }
      catch(e){ console.error(e); }
    }
  }, 600);
}
function nav(dir){currentIndex=Math.max(0,Math.min(allCriteria.length-1,currentIndex+dir));renderCriterion();renderSidebar()}
function updateProgress() {
  const total=allCriteria.length;
  const ans=Object.values(responses).filter(r=>r.conforme!==null&&r.conforme!==undefined).length;
  const pct=total>0?(ans/total)*100:0;
  document.getElementById('pFill').style.width=pct+'%';
  document.getElementById('pCount').textContent=`${ans} / ${total}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• REPORT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderReport() {
  const total=allCriteria.length;
  const ans=Object.values(responses).filter(r=>r.conforme!==null&&r.conforme!==undefined).length;
  const conf=Object.values(responses).filter(r=>r.conforme===true).length;
  const nonC=Object.values(responses).filter(r=>r.conforme===false).length;
  const rate=ans>0?((conf/ans)*100).toFixed(1):0;
  const ecarts=allCriteria.filter(c=>responses[c.id]?.conforme===false).map(c=>({...c,observation:responses[c.id]?.observation||''}));

  const isLeadOrAdmin = ['admin','lead_inspector'].includes(session?.user?.role);
  let insp = null;
  if(currentInspectionId) try { insp = await invoke('cmd_get_inspection',{token:session.token, inspectionId:currentInspectionId}); } catch(_){}
  const canValidate = isLeadOrAdmin && insp && insp.status !== 'validated';
  const canComplete = insp && insp.status === 'in_progress';

  document.getElementById('rptContent').innerHTML=`
    <h2>Rapport d'inspection</h2>
    <p class="sub">${activeGrid?.name||''} Â· ${insp?.establishment||'â€”'} Â· ${insp?.date_inspection||'â€”'}
    ${insp?` Â· <span class="status-badge status-${insp.status}">${statusLabel(insp.status)}</span>`:''}</p>
    <div class="stats-g">
      <div class="stat-c"><div class="stat-v">${total}</div><div class="stat-l">Total</div></div>
      <div class="stat-c"><div class="stat-v">${conf}</div><div class="stat-l">Conformes</div></div>
      <div class="stat-c"><div class="stat-v">${nonC}</div><div class="stat-l">Non conformes</div></div>
      <div class="stat-c"><div class="stat-v">${total-ans}</div><div class="stat-l">Non Ã©valuÃ©s</div></div>
    </div>
    <div style="text-align:center;margin-bottom:8px;font-size:14px;color:var(--text-muted)">Taux de conformitÃ© : <strong style="color:var(--accent)">${rate}%</strong></div>
    <div class="conf-bar"><div class="conf-fill" style="width:${rate}%"></div></div>
    ${ecarts.length?`<div class="ec-title">Ã‰carts <span class="ec-count">${ecarts.length}</span></div>
      ${ecarts.map(e=>`<div class="ecart-card"><div class="sec">${e.sectionTitle}</div><div class="desc">${e.description}</div>
        ${e.reference?`<div class="ref">${e.reference}</div>`:''}${e.observation?`<div class="obs">"${e.observation}"</div>`:''}</div>`).join('')}`
      :'<p style="text-align:center;color:var(--accent);font-weight:500;padding:var(--space-m)">Aucun Ã©cart</p>'}
    <div class="rpt-actions">
      ${canComplete?`<button class="btn-rpt" onclick="setInspStatus('completed')">Marquer terminÃ©e</button>`:''}
      ${canValidate?`<button class="btn-rpt" style="background:var(--accent);color:var(--white)" onclick="setInspStatus('validated')">Valider</button>`:''}
      <button class="btn-rpt" onclick="exportJSON()">Export JSON</button>
      <button class="btn-rpt" onclick="goToDashboard()">Tableau de bord</button>
      <button class="btn-rpt primary" onclick="showScreen('inspection');renderCriterion();updateProgress()">Retour</button>
    </div>`;
}
async function setInspStatus(status) {
  if(!currentInspectionId) return;
  try {
    await invoke('cmd_set_inspection_status',{token:session.token, inspectionId:currentInspectionId, status});
    renderReport();
  } catch(e){ alert(e); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• USERS PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderUsers() {
  try {
    const users = await invoke('cmd_list_users',{token:session.token});
    document.getElementById('usersPanel').innerHTML=`
      <h2>Gestion des utilisateurs</h2>
      <div style="margin-bottom:var(--space-s)"><button class="btn-primary" style="width:auto;padding:8px 16px;font-size:12px" onclick="showCreateUserModal()">+ Nouvel utilisateur</button></div>
      <table class="tbl"><thead><tr><th>Statut</th><th>Nom</th><th>Identifiant</th><th>RÃ´le</th><th>CrÃ©Ã© le</th><th>Actions</th></tr></thead><tbody>
      ${users.map(u=>`<tr>
        <td><span class="active-dot ${u.active?'on':'off'}"></span></td>
        <td><strong>${u.full_name}</strong></td>
        <td class="mono">${u.username}</td>
        <td><span class="role-tag role-${u.role}">${roleLabel(u.role)}</span></td>
        <td class="mono">${u.created_at?.substring(0,10)||'â€”'}</td>
        <td>
          <button class="btn-sm" onclick="showEditUserModal('${u.id}','${esc(u.full_name)}','${u.role}',${u.active})">Modifier</button>
          <button class="btn-sm" onclick="showChangePwModal('${u.id}','${esc(u.full_name)}')">MdP</button>
          ${u.active?`<button class="btn-sm" style="color:var(--accent)" onclick="deactivateUser('${u.id}')">DÃ©sactiver</button>`
            :`<button class="btn-sm" style="color:var(--accent)" onclick="reactivateUser('${u.id}')">RÃ©activer</button>`}
        </td>
      </tr>`).join('')}
      </tbody></table>`;
  } catch(e){ document.getElementById('usersPanel').innerHTML=`<p style="color:var(--accent)">${e}</p>`; }
}
function esc(s){return s.replace(/'/g,"\\'").replace(/"/g,'&quot;')}

function showCreateUserModal() {
  openModal(`<h3>Nouvel utilisateur</h3>
    <div class="field"><label>Nom complet</label><input id="nuName"/></div>
    <div class="field"><label>Identifiant</label><input id="nuUser"/></div>
    <div class="field"><label>Mot de passe</label><input id="nuPass" type="password"/></div>
    <div class="field"><label>RÃ´le</label><select id="nuRole"><option value="inspector">Inspecteur</option><option value="lead_inspector">Inspecteur en chef</option><option value="admin">Administrateur</option><option value="viewer">Lecteur</option></select></div>
    <div class="modal-actions"><button class="btn-sm" onclick="closeModal()">Annuler</button><button class="btn-primary" style="width:auto;padding:8px 16px;font-size:12px" onclick="doCreateUser()">CrÃ©er</button></div>`);
}
async function doCreateUser() {
  try {
    await invoke('cmd_create_user',{token:session.token, req:{username:document.getElementById('nuUser').value,full_name:document.getElementById('nuName').value,role:document.getElementById('nuRole').value,password:document.getElementById('nuPass').value}});
    closeModal(); renderUsers();
  } catch(e){alert(e)}
}
function showEditUserModal(id,name,role,active) {
  openModal(`<h3>Modifier : ${name}</h3>
    <div class="field"><label>Nom complet</label><input id="euName" value="${name}"/></div>
    <div class="field"><label>RÃ´le</label><select id="euRole"><option value="inspector" ${role==='inspector'?'selected':''}>Inspecteur</option><option value="lead_inspector" ${role==='lead_inspector'?'selected':''}>Inspecteur en chef</option><option value="admin" ${role==='admin'?'selected':''}>Administrateur</option><option value="viewer" ${role==='viewer'?'selected':''}>Lecteur</option></select></div>
    <div class="modal-actions"><button class="btn-sm" onclick="closeModal()">Annuler</button><button class="btn-primary" style="width:auto;padding:8px 16px;font-size:12px" onclick="doEditUser('${id}')">Enregistrer</button></div>`);
}
async function doEditUser(id) {
  try { await invoke('cmd_update_user',{token:session.token, userId:id, req:{full_name:document.getElementById('euName').value,role:document.getElementById('euRole').value}}); closeModal(); renderUsers(); } catch(e){alert(e)}
}
function showChangePwModal(id,name) {
  openModal(`<h3>Mot de passe : ${name}</h3>
    <div class="field"><label>Nouveau mot de passe</label><input id="cpPass" type="password"/></div>
    <div class="modal-actions"><button class="btn-sm" onclick="closeModal()">Annuler</button><button class="btn-primary" style="width:auto;padding:8px 16px;font-size:12px" onclick="doChangePw('${id}')">Changer</button></div>`);
}
async function doChangePw(id) { try { await invoke('cmd_change_password',{token:session.token, userId:id, newPassword:document.getElementById('cpPass').value}); closeModal(); } catch(e){alert(e)} }
async function deactivateUser(id) { if(!confirm('DÃ©sactiver cet utilisateur ?')) return; try { await invoke('cmd_delete_user',{token:session.token, userId:id}); renderUsers(); } catch(e){alert(e)} }
async function reactivateUser(id) { try { await invoke('cmd_update_user',{token:session.token, userId:id, req:{active:true}}); renderUsers(); } catch(e){alert(e)} }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• AUDIT PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let auditPage = 0;
async function renderAudit(page) {
  if(page!==undefined) auditPage=page;
  const limit=50, offset=auditPage*limit;
  try {
    const logs = await invoke('cmd_query_audit',{token:session.token, filter:{limit, offset}});
    const total = await invoke('cmd_count_audit',{token:session.token, filter:{}});
    const pages = Math.ceil(total/limit);
    document.getElementById('auditPanel').innerHTML=`
      <h2>Journal d'audit <span style="font-size:14px;color:var(--text-muted);font-weight:400">${total} entrÃ©es</span></h2>
      <table class="tbl"><thead><tr><th>Date/Heure</th><th>Utilisateur</th><th>Action</th><th>EntitÃ©</th><th>ID</th><th>DÃ©tails</th></tr></thead><tbody>
      ${logs.map(l=>`<tr>
        <td class="mono">${l.timestamp||'â€”'}</td>
        <td>${l.username||'<span style="color:var(--text-muted)">systÃ¨me</span>'}</td>
        <td><span class="action-tag">${l.action}</span></td>
        <td>${l.entity_type||'â€”'}</td>
        <td class="mono" style="max-width:120px;overflow:hidden;text-overflow:ellipsis">${l.entity_id?.substring(0,12)||'â€”'}</td>
        <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;font-size:12px;color:var(--text-muted)">${l.details||''}</td>
      </tr>`).join('')}
      </tbody></table>
      <div style="display:flex;justify-content:center;gap:8px;margin-top:var(--space-m)">
        ${auditPage>0?`<button class="btn-sm" onclick="renderAudit(${auditPage-1})">â† PrÃ©cÃ©dent</button>`:''}
        <span style="padding:8px 12px;font-size:12px;color:var(--text-muted)">Page ${auditPage+1}/${pages||1}</span>
        ${auditPage<pages-1?`<button class="btn-sm" onclick="renderAudit(${auditPage+1})">Suivant â†’</button>`:''}
      </div>`;
  } catch(e){ document.getElementById('auditPanel').innerHTML=`<p style="color:var(--accent)">${e}</p>`; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(html) { document.getElementById('modalContent').innerHTML=html; document.getElementById('modalOverlay').classList.add('visible'); }
function closeModal() { document.getElementById('modalOverlay').classList.remove('visible'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• EXPORT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportJSON() {
  const rpt = { meta:{grid:activeGrid?.name,grid_id:activeGrid?.id,establishment:document.getElementById('mEstab')?.value,date:document.getElementById('mDate')?.value,inspection_id:currentInspectionId},
    total:allCriteria.length, conforme:Object.values(responses).filter(r=>r.conforme===true).length, non_conforme:Object.values(responses).filter(r=>r.conforme===false).length,
    ecarts:allCriteria.filter(c=>responses[c.id]?.conforme===false).map(c=>({id:c.id,section:c.sectionTitle,reference:c.reference,description:c.description,observation:responses[c.id]?.observation||''})),
    all_responses:Object.entries(responses).map(([id,r])=>({criterion_id:parseInt(id),...r}))};
  const blob=new Blob([JSON.stringify(rpt,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`rapport_${activeGrid?.id||'x'}_${Date.now()}.json`;a.click();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• KEYBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown',e=>{
  if(!document.getElementById('s-inspection').classList.contains('visible'))return;
  if(e.target.tagName==='TEXTAREA'||e.target.tagName==='INPUT')return;
  if(e.key==='ArrowRight'){e.preventDefault();nav(1)} if(e.key==='ArrowLeft'){e.preventDefault();nav(-1)}
  if(e.key==='o'||e.key==='O'){const c=allCriteria[currentIndex];if(c)setResp(c.id,true)}
  if(e.key==='n'||e.key==='N'){const c=allCriteria[currentIndex];if(c)setResp(c.id,false)}
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• showScreen('grid-select') hook â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _showScreen = showScreen;
showScreen = function(name) { _showScreen(name); if(name==='grid-select') renderGridSelector(); };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• JS FALLBACK GRIDS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildAllGridsJS(){let id=0;const n=(r,d,p)=>({id:++id,reference:r,description:d,pre_opening:p});const it=(r,d)=>n(r,d,false);const pr=(r,d)=>n(r,d,true);
const off={id:'officine',name:'Inspection Officine',code:'IP-F-0018',version:'1',description:"Grille d'inspection des officines",icon:'ğŸ’Š',color:'#DC2626',sections:[
{id:1,title:"Renseignements gÃ©nÃ©raux",items:[pr("Loi 2021-03 Art 46","Identification de la structure"),it("Loi 2021-03 Art 61,62","Mode d'acquisition"),it("","Statut ou mode d'exploitation"),it("Loi 2021-03 Art 62","Quitus d'exploitation"),it("","Adresse, Tel, Mail"),it("Loi 2021-03 Art 59,62","Localisation"),it("","Correspondance attribution/site"),it("Loi 2021-03 Art 65","Horaires affichÃ©s"),it("BPDisp 1.14","Service de garde")]},
{id:2,title:"SMQ",items:[pr("BPDisp 1.3-1.5","SMQ en place ?"),pr("BPDisp 1.6","RMQ dÃ©signÃ© ?"),pr("BPDisp 1.16","Gestion risque qualitÃ©"),it("BPDisp 1.15-1.17","SÃ©curitÃ© du patient"),pr("BPDisp 1.31a,f","Moyens acte pharmaceutique"),pr("BPDisp 1.31g","TraÃ§abilitÃ©")]},
{id:3,title:"Personnel",items:[pr("BPDisp 2.2","Personnel suffisant"),pr("BPDisp 2.3","Organigramme"),pr("BPDisp 2.4","Inscription Ordre"),it("BPDisp 2.9,2.10","PrÃ©sence pharmacien"),it("DÃ©cret 1296","Conditions assistance"),it("BPDisp 2.5","Remplacement"),it("BPDisp 2.11","Badge"),it("BPDisp 2.12","Entretien annuel"),pr("BPDisp 2.8","Formation initiale"),pr("BPDisp 2.14-2.20","Formation continue"),it("BPDisp 2.18","Suivi formations"),it("BPDisp 2.21","HygiÃ¨ne")]},
{id:4,title:"Documentation",items:[pr("BPDisp 3.4-3.9","Ordonnancier (10 ans)"),pr("","Registre stupÃ©fiants"),pr("BPDisp 3.6,3.7","Registre dÃ©rivÃ©s sang"),pr("BPDisp 3.4a","Registre prÃ©parations"),it("BPDisp 3.11,3.12","Copies ordonnances"),pr("","Documents officiels"),pr("BPDisp 1.22-1.28","ProcÃ©dures qualitÃ©"),pr("BPDisp 3.16-3.20","MaÃ®trise documentaire"),pr("BPDisp 3.22","Ã‰valuation pÃ©riodique"),pr("BPDisp 3.23","Gestion modifications"),pr("BPDisp 3.21","Documents approuvÃ©s"),it("BPDisp 3.24","Gestion diffusion"),it("BPDisp 3.25","Cycle de vie documents"),it("BPDisp 3.13","Enregistrements"),it("BPDisp 2.13","Archives"),it("BPDisp 3.28","Documents santÃ© publique")]},
{id:5,title:"Locaux et Ã©quipements",items:[pr("Loi Art 46","EmblÃ¨me, enseigne"),pr("BPDisp 4.1-4.22","PropretÃ© locaux"),pr("BPDisp 4.7","Stockage dangereux"),pr("BPDisp 4.7,4.8","SÃ©curitÃ©"),pr("BPDisp 4.6","Disposition mÃ©dicaments"),pr("BPDisp 3.15,4.10","Zone prÃ©paration"),pr("BPDisp 4.18","Ã‰clairage, tempÃ©rature"),pr("BPDisp 4.21","Sanitaires"),pr("BPDisp 1.7,4.23","MatÃ©riel qualifiÃ©"),it("BPDisp 4.24","Entretien matÃ©riel"),it("BPDisp 4.25","Ã‰talonnage"),it("BPDisp 4.26","SI validÃ©"),it("BPDisp 4.30","Contrat SI"),it("BPDisp 4.33","AccÃ¨s informatique"),it("BPDisp 4.34","Sauvegarde"),it("BPDisp 4.36","Mesures remplacement"),it("DÃ©cret 1296","Vente en ligne")]},
{id:6,title:"Approvisionnement",items:[it("BPDisp 5.1,5.2","Stock sÃ©curitÃ©"),it("BPDisp 5.3","Commerce hors liste"),it("BPDisp 5.7-5.9","Commandes"),it("Loi 97-025","StupÃ©fiants souches"),it("BPDisp 5.10","Transport rÃ©ception"),it("BPDisp 5.11","RÃ©ception hors heures"),pr("BPDisp 5.12","Colis vÃ©rifiÃ©s")]},
{id:7,title:"Sous-traitance",items:[it("Annexe 6.13","Contrat et audit")]},
{id:8,title:"Dispensation",items:[it("Loi 97-025","Substances vÃ©nÃ©neuses"),it("","1Ã¨re dÃ©livrance < 3 mois"),it("","Renouvellement max 12 mois"),it("BPDisp 7.14","Acte intÃ©gral"),it("BPDisp 7.16","Surveillance"),it("BPDisp 7.17","Substitution"),it("BPDisp 7.18","Refus si risque"),it("BPDisp 7.19-7.42","Acte complet"),it("BPDisp 7.34","Mentions exÃ©cution"),it("","Dispensation chronique"),it("","VÃ©tÃ©rinaires"),it("","DM, cosmÃ©tiques"),it("BPDisp 7.36","StupÃ©fiants"),it("BPDisp 7.43-7.48","Conseil"),it("Loi Art 77","Notification EI"),it("BPDisp 7.52","Vente en ligne"),it("","Emballage"),it("BPDisp 7.65","RÃ©duction"),it("BPDisp 7.60","Livraison domicile")]},
{id:9,title:"Retours/RÃ©clamations",items:[it("BPDisp 8.3","Gestion retours"),it("BPDisp 8.4","MNU"),it("BPDisp 8.5","Produits rÃ©cupÃ©rÃ©s"),it("BPDisp 8.12","Retraits")]},
{id:10,title:"DÃ©chets",items:[it("BPDisp 9.2","Gestion dÃ©chets")]},
{id:11,title:"PrÃ©parations",items:[pr("BPDisp 3.4-a","Personnel et local"),it("","MatiÃ¨res premiÃ¨res"),it("","ProcÃ©dures"),it("BPDisp 3.4","Ã‰tiquetage"),it("","LibÃ©ration")]},
{id:12,title:"PublicitÃ©/PSQIF",items:[it("Ord 73-30","PublicitÃ©"),it("Loi Art 54","Pratique illÃ©gale"),it("BPDisp 5.5","PSQIF")]},
{id:13,title:"Auto-inspection",items:[it("BPDisp 10.1","Couverture SMQ"),it("","Enregistrements"),it("","Mesures correctives"),it("","Suivi")]}]};
id=0;
const gro={id:'grossiste',name:'Inspection Grossiste-RÃ©partiteur',code:'IP-FO-0002',version:'1',description:"Grille grossiste-rÃ©partiteur selon BPD/UEMOA",icon:'ğŸ­',color:'#DC2626',sections:[
{id:1,title:"Organisation et gestion",items:[pr("BPD/I 1.01","AutorisÃ© ? Pharmacien ?"),pr("BPD/I 1.02","Organigramme"),pr("BPD/I 1.03","Pharmacien par site"),it("BPD/I 1.04","AutoritÃ© et ressources"),it("BPD/I 1.05,1.06","Conflits d'intÃ©rÃªts"),it("BPD/I 1.07","Descriptions de fonction"),it("BPD/I 1.08","Sous-traitance"),it("BPD/I 1.09","SÃ©curisation")]},
{id:2,title:"Gestion de la qualitÃ©",items:[pr("BPD/I 1.10,1.11","SystÃ¨me AQ ?"),pr("BPD/I 1.13","ResponsabilitÃ© partagÃ©e"),it("BPD/I 1.14","E-commerce traÃ§abilitÃ©"),pr("BPD/I 1.15","Fournisseurs approuvÃ©s"),pr("BPD/I 1.16","TraÃ§abilitÃ©"),pr("BPD/I 1.18","ProcÃ©dures opÃ©rations")]},
{id:3,title:"Personnel",items:[pr("BPD/I 1.19","Personnel formÃ© BPD"),pr("BPD/I 1.20","Personnel clÃ© compÃ©tent"),pr("BPD/I 1.21","Effectifs suffisants"),it("BPD/I 1.22","Qualifications"),pr("BPD/I 1.23","Formation continue"),it("BPD/I 1.24","Formations enregistrÃ©es"),it("BPD/I 1.25","Formation dangereux"),it("BPD/I 1.26","VÃªtements"),it("BPD/I 1.27","HygiÃ¨ne"),it("BPD/I 1.28","DÃ©tention non autorisÃ©e"),it("BPD/I 1.29","DÃ©tournements"),it("DÃ©cret 2024-1301","Pharmacien 5 ans exp."),it("Loi 2021-03","Pharmaciens adjoints")]},
{id:4,title:"Documentation",items:[pr("BPD/I 1.30","Instructions Ã©crites"),pr("BPD/I 1.31","Documents approuvÃ©s"),it("BPD/I 1.32","Contenu clair"),it("BPD/I 1.33","Revue rÃ©guliÃ¨re"),pr("BPD/I 1.34","Enregistrements accessibles"),it("BPD/I 1.35","DonnÃ©es protÃ©gÃ©es"),it("BPD/I 1.36,1.37","SI validÃ©")]},
{id:5,title:"RÃ©clamations",items:[it("BPD/I 1.38","ProcÃ©dure rÃ©clamations"),it("BPD/I 1.39","Enregistrement examen"),it("BPD/I 1.40","Personne responsable"),it("BPD/I 1.42","Mesures rÃ©visÃ©es")]},
{id:6,title:"Rappels",items:[it("BPD/I 1.43","SystÃ¨me de rappel"),it("BPD/I 1.44","Rappel immÃ©diat"),it("BPD/I 1.45","Ã‰valuation risque"),it("BPD/I 1.47","TraÃ§abilitÃ© destinataires"),it("BPD/I 1.48","Produits rappelÃ©s isolÃ©s")]},
{id:7,title:"Sous-traitance",items:[it("BPD/I 1.49","Contrat Ã©crit"),it("BPD/I 1.50","Sous-traitant autorisÃ©"),it("BPD/I 1.51","Audits rÃ©guliers")]},
{id:8,title:"Auto-inspections",items:[it("BPD/I 1.53","Auto-inspections rÃ©guliÃ¨res"),it("BPD/I 1.54","Programme complet"),it("BPD/I 1.55","Rapports et actions"),it("BPD/I 1.56","Actions correctives")]},
{id:9,title:"Locaux",items:[pr("BPD/I 2.01","Locaux vastes et entretenus"),pr("BPD/I 2.02","Zones conditions stockage"),pr("BPD/I 2.03","Anti-nuisibles"),pr("BPD/I 2.04","AccÃ¨s restreint"),pr("BPD/I 2.05","Disposition logique"),pr("BPD/I 2.06","CapacitÃ© suffisante")]},
{id:10,title:"RÃ©ception",items:[pr("BPD/I 2.07","Quais protÃ©gÃ©s"),pr("BPD/I 2.08","Zone quarantaine"),pr("BPD/I 2.09","Produits refusÃ©s sÃ©parÃ©s")]},
{id:11,title:"Stockage",items:[pr("BPD/I 2.10","Stockage ordonnÃ© FEFO"),pr("BPD/I 2.11","PropretÃ©"),pr("BPD/I 2.12","Conditions spÃ©ciales"),pr("BPD/I 2.13","Surveillance TÂ°"),it("BPD/I 2.14","Mapping tempÃ©rature"),pr("BPD/I 2.15","StupÃ©fiants sÃ©curisÃ©s"),it("BPD/I 2.16","Zones produits dangereux")]},
{id:12,title:"VÃ©hicules et matÃ©riels",items:[it("BPD/I 2.17","VÃ©hicules adaptÃ©s"),it("BPD/I 2.18","Entretien documentÃ©"),it("BPD/I 2.19","Surveillance TÂ° vÃ©hicules")]},
{id:13,title:"Approvisionnement",items:[pr("BPD/I 3.01","Fournisseurs autorisÃ©s"),pr("BPD/I 3.02","Enregistrements"),it("BPD/I 3.03","VÃ©rifications rÃ©ception"),it("Loi 97-025","StupÃ©fiants souches")]},
{id:14,title:"OpÃ©rations de stockage",items:[it("BPD/I 3.05","Statuts produits"),it("BPD/I 3.07","Conditions AMM"),it("BPD/I 3.09","StupÃ©fiants sÃ©curisÃ©s"),it("BPD/I 3.10","Rotation FEFO"),it("BPD/I 3.11","PÃ©remptions vÃ©rifiÃ©es"),it("BPD/I 3.13","Inventaires documentÃ©s"),it("BPD/I 3.14","Inventaires trimestriels")]},
{id:15,title:"PrÃ©paration commandes",items:[it("BPD/I 3.15","ProcÃ©dure et contrÃ´le"),it("BPD/I 3.16","Documents accompagnement"),it("BPD/I 3.17","TraÃ§abilitÃ©"),it("BPD/I 3.18","Vente aux autorisÃ©s")]},
{id:16,title:"ExpÃ©dition/Transport",items:[it("BPD/I 4.01","Emballage conforme"),it("BPD/I 4.02","FEFO Ã©tiquetage"),it("BPD/I 4.04-4.08","ChaÃ®ne du froid"),it("BPD/I 4.09","Anti-vol"),it("BPD/I 4.11","VÃ©hicules propres"),it("BPD/I 4.15","Calendriers livraison"),it("BPD/I 4.17","VÃ©rification livraison")]},
{id:17,title:"Produits refusÃ©s/retournÃ©s",items:[it("BPD/I 5.01","RefusÃ©s sÃ©parÃ©s"),it("BPD/I 5.02","Enregistrements retours"),it("BPD/I 5.03","Destruction traÃ§able"),it("BPD/I 5.04","Retours quarantaine"),it("BPD/I 5.06","FalsifiÃ©s signalÃ©s")]},
{id:18,title:"ContrefaÃ§on/PSQIF",items:[it("BPD/I 6.01","SystÃ¨me PSQIF"),it("BPD/I 6.04","VÃ©rification authenticitÃ©"),it("BPD/I 6.05","Personnel formÃ©"),it("Loi 2021-03","Notification autoritÃ©s")]}]};
return[off,gro];}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• INIT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', ()=>{ document.getElementById('loginUser').focus(); });
</script>
</body>
</html>
